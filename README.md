# UPD: в версии 9.4 нативно добавлены Let's сертификаты из панели управления.

# Создаем Kerio Connect server и прописываем автосертификаты для всех доменов

## Описание
- Данный репозиторий позволяет создать ВМ в [GCP](https://console.cloud.google.com), развернуть там Kerio Connect сервер, а так же настроить автоматическое получение SSL сертификатов от letsencrypt для всех почтовых доменов сервера

### Фактически:
- проект состоит из двух частей: terraform - для создания машины и установки Kerio и ansible - которая может настраивать Керио (в том числе и на существующих серверах)
- думаю, вторая часть вам пригодиться больше, т.к. первую я писал, дабы тестировать работу ansible

### Предварительные требования
- предполагается, что вы уже зарегистрированы в [GCP](https://console.cloud.google.com) и создали персональный проект
- для начально работы (в MacOS) необходимо установить [terraform](https://www.terraform.io)
  > brew install terraform

- и [Ansible](https://docs.ansible.com)
  > brew install ansible

#### Создание виртуальной машины
- переименовываем файл **vars.tf.example** в **vars.tf**
- переименовываем файл **terraform.tfvars.example** в **terraform.tfvars**
- заполняем переменные по вашему усмотрению

- инициализируем:
 	> terraform init && terraform plan

- создаем ВМ:
 	> terraform apply

#### Установка Kerio-connect
- этот скрипт скачивает последнюю версию Kerio Connect с сайта-производителя, нужно лишь правильно выставить переменную wget_kci_path в terraform/terraform.tfvars, но вы можете пропустить этот шаг, если уже установили керио сами.
- после отработки terraform, нужно зайти по ssh на сервер и запустить, который установит Керио
	> bash install.sh

- к сожалению, автоматическая установка deb-пакета Керио мне не подвернулась, так же как и активация тестовой лицензии. Придется размять руки.

####
- перед запуском не забыть обновить роли!
  > ansible-galaxy install -r requirements.yml


#### Финальная настройка
- что бы ansible скрипт корретно работал, скрипт потушит kerio-connect и запустит certbot --standalone сервер на время выпуска сертификатов
- в файле ansible/init.yml необходимо прописать необходимые хосты и их состояние:
	- present - установит и настроит домен и сертификат
	- absent - удалит все линки на домены при следующем проходе (после чего можно так же удалить это упомянание в файле ansible/init.yml), а так же произведет корректный refork & delete сертификатов на сервере letsencrypt
	- есть ключ dry-run - по умолчанию включен - что бы проверить перед запуском, все ли верно прописано. Для рабочего запуска его нужно обнулить:
		> lets_dry_run: ""

	- есть ключ	lets_crontab_enable: "disable", который соответсственно добавляет (enable) или удаляет запись в кроне, на запуск обновлений всех сертификатов 1 раз месяц

#### Запуск
- запускаете ansible-playbook init.yml (если сервер уже существовал, позаботьтесь о верных данных в ansible/inventory и ssh ключах, что бы ansible смог корректно подключиться к вашему серверу)
- после успешного завершения Керио запустится, а в списке сертификатов появятся новые сертификаты, останется только выбрать и активировать сертификат по умолчанию для самого сервера

#### Как я все это делал
- Видео с подробными инструкциями доступно [тут](https://youtu.be/-TDIQBVnjVs)

##### Автор
- **Vassiliy Yegorov** - *Initial work* - [vasyakrg](https://github.com/vasyakrg)
- [сайт](vk.com/realmanual)
- [youtube](youtube.com/realmanual)
