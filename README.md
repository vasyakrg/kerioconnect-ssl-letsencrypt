# Create Kerio Connect server

## Описание
- Данный репозиторий позволяет создать ВМ в [GCP](https://console.cloud.google.com), развернуть там Kerio Connect сервер, а так же настроить автоматическое получение SSL сертификатов от letsencrypt для всех почтовых доменов сервера

### Фактически:
- проект состоит из двух частей: terraform - для создания машины и установки Kerio и ansible - которая может настраивать Керио (в том числе и на существующих серверах)
- думаю, вторая часть вам пригодиться больше, т.к. первую я писал, дабы тестировать работу ansible

### Предварительные требования
- предполагается, что вы уже зарегистрированы в [GCP](https://console.cloud.google.com) и создали персональный проект
- для начально работы (в MacOS) необходимо установить [terraform](https://www.terraform.io)
  > brew install terraform

- и [Ansible](https://docs.ansible.com)
  > brew install ansible

#### Создание виртуальной машины
- переименовываем файл **vars.tf.example** в **vars.tf**
- переименовываем файл **terraform.tfvars.example** в **terraform.tfvars**
- заполняем переменные по вашему усмотрению

- инициализируем:
 	> terraform init && terraform plan

- создаем ВМ:
 	> terraform apply

#### Установка Kerio-connect
- этот скрипт скачивает последнюю версию Kerio Connect с сайта-производителя, нужно лишь правильно выставить переменную wget_kci_path в terraform/terraform.tfvars, но вы можете пропустить этот шаг, если уже установили керио сами.
- после отработки terraform, нужно зайти по ssh на сервер и запустить
	> bash install.sh

- к сожалению, автоматическая установка мне не подвернулась, так же как и активацию тестовой лицензии. Придется размять руки

который установит Керио

#### Финальная настройка
- что бы ansible скрипт корретно работал, необходимо перенастроить службы http и https у Керио, удалив мапинг на стандартные порты 80 и 443. Это нужно что бы nginx корректно установился и прописал домены, завернув их на себя, и что бы letsencrypt смог проверить, что домены памятся на ваш сервер
- после этого перезапустить керио службы вручную
- далее в файле ansible/init.yml необходимо прописать необходимые хосты и их состояние:
	- present - установит и настроит домен и сертификат
	- absent - удалит все линк на домен при следующем проходе (после чего можно так же удалить это упомянание в файле ansible/init.yml)
- далее просто запускаете ansible-playbook init.yml (если сервер уже существовал, позаботьтесь о верных данных в ansible/inventory и ssh ключах, что бы ansible смог корректно подключиться к вашему серверу)
- после успешного завершения работы так же автоматом перезапустится сам Керио

#### Как я все это делал
- Видео с подробными инструкциями доступно [тут]()

##### Автор
- **Vassiliy Yegorov** - *Initial work* - [vasyakrg](https://github.com/vasyakrg)
- [сайт](vk.com/realmanual)
- [youtube](youtube.com/realmanual)
